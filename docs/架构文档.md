# Claude Code Hub 架构文档

> 版本：1.0.0
> 更新日期：2025-12-14
> 作者：Claude Code

---

## 目录

1. [系统架构概览](#1-系统架构概览)
2. [技术栈](#2-技术栈)
3. [目录结构](#3-目录结构)
4. [核心模块](#4-核心模块)
5. [数据流](#5-数据流)
6. [数据库设计](#6-数据库设计)
7. [缓存设计](#7-缓存设计)
8. [安全架构](#8-安全架构)
9. [扩展性设计](#9-扩展性设计)

---

## 1. 系统架构概览

### 1.1 高层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │Claude Code│  │ Codex CLI│  │ 第三方App │  │ Web 浏览器│        │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘        │
└───────┼─────────────┼─────────────┼─────────────┼───────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     API 网关层 (Next.js + Hono)                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Proxy Handler                         │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │  │  Auth   │→│ Session │→│  Rate   │→│ Filter  │       │    │
│  │  │  Guard  │ │  Guard  │ │  Limit  │ │  Guard  │       │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  │       │                                    │            │    │
│  │       ▼                                    ▼            │    │
│  │  ┌─────────────────────────────────────────────┐       │    │
│  │  │           Provider Selector                  │       │    │
│  │  │  (权重 + 优先级 + 熔断器 + Session 粘性)      │       │    │
│  │  └─────────────────────────────────────────────┘       │    │
│  │                        │                                │    │
│  │                        ▼                                │    │
│  │  ┌─────────────────────────────────────────────┐       │    │
│  │  │           Proxy Forwarder                    │       │    │
│  │  │  (请求转发 + 格式转换 + 重试 + 故障转移)      │       │    │
│  │  └─────────────────────────────────────────────┘       │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
        │                                           │
        ▼                                           ▼
┌───────────────────┐                   ┌───────────────────┐
│   数据存储层       │                   │   上游供应商层     │
│  ┌─────────────┐  │                   │  ┌─────────────┐  │
│  │ PostgreSQL  │  │                   │  │   Claude    │  │
│  │  (持久化)    │  │                   │  │   API       │  │
│  └─────────────┘  │                   │  └─────────────┘  │
│  ┌─────────────┐  │                   │  ┌─────────────┐  │
│  │   Redis     │  │                   │  │   OpenAI    │  │
│  │  (缓存/限流) │  │                   │  │   API       │  │
│  └─────────────┘  │                   │  └─────────────┘  │
└───────────────────┘                   │  ┌─────────────┐  │
                                        │  │   Gemini    │  │
                                        │  │   API       │  │
                                        │  └─────────────┘  │
                                        └───────────────────┘
```

### 1.2 请求处理流程

```
请求到达 → 格式检测 → 认证校验 → Session 分配 → 限流检查 →
敏感词检测 → 请求过滤 → 供应商选择 → 请求转发 → 响应处理 → 返回客户端
```

---

## 2. 技术栈

### 2.1 前端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 15.x | 全栈框架 |
| React | 19.x | UI 框架 |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 3.x | 样式框架 |
| Ant Design | 5.x | UI 组件库 |
| Radix UI | - | 无障碍组件 |
| Recharts | - | 图表库 |

### 2.2 后端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Hono | 4.x | API 路由框架 |
| Drizzle ORM | - | 数据库 ORM |
| ioredis | - | Redis 客户端 |
| undici | - | HTTP 客户端 |
| Zod | - | 数据验证 |
| Pino | - | 日志框架 |

### 2.3 基础设施

| 技术 | 版本 | 用途 |
|------|------|------|
| PostgreSQL | 18.x | 主数据库 |
| Redis | 7.x | 缓存/限流/Session |
| Docker | - | 容器化部署 |
| Bun | 1.3+ | 运行时/包管理 |

---

## 3. 目录结构

```
claude-api-gateway/
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── [locale]/                 # 国际化页面
│   │   │   ├── dashboard/            # 管理后台页面
│   │   │   │   ├── page.tsx          # 仪表盘首页
│   │   │   │   ├── users/            # 用户管理
│   │   │   │   ├── quotas/           # 配额管理
│   │   │   │   ├── logs/             # 日志查看
│   │   │   │   ├── leaderboard/      # 排行榜
│   │   │   │   ├── sessions/         # Session 监控
│   │   │   │   ├── availability/     # 可用性监控
│   │   │   │   └── settings/         # 系统设置
│   │   │   └── login/                # 登录页面
│   │   ├── api/                      # 内部 API
│   │   │   ├── actions/              # Server Actions API
│   │   │   ├── auth/                 # 认证 API
│   │   │   ├── leaderboard/          # 排行榜 API
│   │   │   └── prices/               # 价格 API
│   │   ├── v1/                       # 代理 API (主要)
│   │   │   ├── [[...path]]/          # 通配路由
│   │   │   └── _lib/                 # 代理核心逻辑
│   │   │       ├── proxy-handler.ts  # 主处理器
│   │   │       ├── proxy/            # 代理模块
│   │   │       ├── guards/           # 守卫模块
│   │   │       ├── converters/       # 格式转换器
│   │   │       ├── codex/            # Codex 支持
│   │   │       ├── gemini/           # Gemini 支持
│   │   │       └── headers/          # 请求头处理
│   │   └── v1beta/                   # Beta API
│   │
│   ├── actions/                      # Server Actions
│   │   ├── users.ts                  # 用户操作
│   │   ├── keys.ts                   # Key 操作
│   │   ├── providers.ts              # 供应商操作
│   │   ├── logs.ts                   # 日志操作
│   │   └── settings.ts               # 设置操作
│   │
│   ├── components/                   # UI 组件
│   │   ├── ui/                       # 基础 UI 组件
│   │   ├── dashboard/                # 仪表盘组件
│   │   └── providers/                # Context Providers
│   │
│   ├── drizzle/                      # 数据库配置
│   │   ├── schema.ts                 # 数据库 Schema
│   │   ├── db.ts                     # 数据库连接
│   │   └── migrate.ts                # 迁移脚本
│   │
│   ├── lib/                          # 核心业务逻辑
│   │   ├── auth/                     # 认证模块
│   │   ├── circuit-breaker/          # 熔断器
│   │   ├── rate-limit/               # 限流模块
│   │   ├── session-manager/          # Session 管理
│   │   ├── proxy-agent/              # 代理 Agent
│   │   ├── price-sync/               # 价格同步
│   │   ├── notification/             # 通知模块
│   │   ├── config/                   # 配置管理
│   │   ├── logger/                   # 日志模块
│   │   └── redis/                    # Redis 客户端
│   │
│   ├── repository/                   # 数据访问层
│   │   ├── users.ts                  # 用户仓库
│   │   ├── keys.ts                   # Key 仓库
│   │   ├── providers.ts              # 供应商仓库
│   │   ├── logs.ts                   # 日志仓库
│   │   └── statistics.ts             # 统计仓库
│   │
│   └── types/                        # 类型定义
│       ├── api.ts                    # API 类型
│       ├── database.ts               # 数据库类型
│       └── provider.ts               # 供应商类型
│
├── drizzle/                          # 数据库迁移文件
├── messages/                         # 国际化文件
├── public/                           # 静态资源
├── scripts/                          # 工具脚本
├── deploy/                           # 部署配置
└── docs/                             # 文档
```

---

## 4. 核心模块

### 4.1 代理处理器 (Proxy Handler)

**位置**：`src/app/v1/_lib/proxy-handler.ts`

代理处理器是系统的核心，负责处理所有 API 请求：

```typescript
// 处理流程
async function handleProxyRequest(c: Context) {
  // 1. 格式检测
  const format = detectFormat(c);

  // 2. 创建 Session
  const session = new ProxySession(c, format);

  // 3. 执行守卫链
  await AuthGuard.check(session);
  await SessionGuard.check(session);
  await RateLimitGuard.check(session);
  await SensitiveWordGuard.check(session);
  await RequestFilterGuard.check(session);

  // 4. 选择供应商
  const provider = await ProviderSelector.select(session);

  // 5. 转发请求
  const response = await ProxyForwarder.send(session);

  // 6. 处理响应
  return ResponseHandler.process(session, response);
}
```

### 4.2 供应商选择器 (Provider Selector)

**位置**：`src/app/v1/_lib/proxy/provider-selector.ts`

供应商选择算法：

```
1. 获取所有启用的供应商
2. 过滤：用户分组 → 模型支持 → 熔断状态
3. 按优先级分组
4. 在最高优先级组内按权重随机选择
5. 检查 Session 粘性（5 分钟内复用同一供应商）
```

### 4.3 熔断器 (Circuit Breaker)

**位置**：`src/lib/circuit-breaker/`

熔断器状态机：

```
CLOSED ──(失败次数达到阈值)──→ OPEN
   ↑                            │
   │                            │
   │                      (等待超时)
   │                            │
   │                            ▼
   └──(成功次数达到阈值)── HALF_OPEN
```

### 4.4 限流器 (Rate Limiter)

**位置**：`src/lib/rate-limit/`

限流维度：

| 维度 | 实现方式 | 存储 |
|------|----------|------|
| RPM | 滑动窗口 | Redis |
| 金额限制 | 累计计数 | Redis + PostgreSQL |
| 并发限制 | 计数器 | Redis |

### 4.5 Session 管理器

**位置**：`src/lib/session-manager/`

Session 功能：

- 5 分钟上下文缓存
- 供应商粘性
- 并发控制
- 决策链记录

---

## 5. 数据流

### 5.1 请求数据流

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ 客户端   │────→│ Next.js │────→│  Hono   │────→│ Guards  │
└─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                      │
                                                      ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ 上游API │←────│Forwarder│←────│Selector │←────│ Session │
└────┬────┘     └─────────┘     └─────────┘     └─────────┘
     │
     ▼
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Response│────→│Transform│────→│ 客户端   │
└─────────┘     └─────────┘     └─────────┘
```

### 5.2 数据存储流

```
┌─────────────────────────────────────────────────────────┐
│                      应用层                              │
└───────────────────────┬─────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌───────────┐   ┌───────────┐   ┌───────────┐
│ Repository│   │   Redis   │   │  Logger   │
│  (CRUD)   │   │  (Cache)  │   │  (Audit)  │
└─────┬─────┘   └─────┬─────┘   └─────┬─────┘
      │               │               │
      ▼               ▼               ▼
┌───────────┐   ┌───────────┐   ┌───────────┐
│PostgreSQL │   │   Redis   │   │PostgreSQL │
│  (Data)   │   │  (State)  │   │  (Logs)   │
└───────────┘   └───────────┘   └───────────┘
```

---

## 6. 数据库设计

### 6.1 ER 图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   users     │       │    keys     │       │  providers  │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │──┐    │ id (PK)     │       │ id (PK)     │
│ name        │  │    │ user_id(FK) │───┐   │ name        │
│ role        │  │    │ key         │   │   │ url         │
│ quotas...   │  │    │ quotas...   │   │   │ key         │
└─────────────┘  │    └─────────────┘   │   │ type        │
                 │                      │   │ weight      │
                 │    ┌─────────────┐   │   │ priority    │
                 │    │message_req  │   │   └─────────────┘
                 │    ├─────────────┤   │         │
                 └───→│ user_id(FK) │←──┘         │
                      │provider_id  │←────────────┘
                      │ model       │
                      │ tokens      │
                      │ cost_usd    │
                      └─────────────┘
```

### 6.2 核心表结构

#### users 表

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL UNIQUE,
  description TEXT,
  role VARCHAR(50) DEFAULT 'user',
  rpm_limit INTEGER DEFAULT 0,
  daily_limit_usd DECIMAL(10,4) DEFAULT 0,
  provider_group VARCHAR(255),
  tags JSONB DEFAULT '[]',

  -- 配额字段
  quota_5h_usd DECIMAL(10,4),
  quota_weekly_usd DECIMAL(10,4),
  quota_monthly_usd DECIMAL(10,4),
  quota_total_usd DECIMAL(10,4),
  concurrent_limit INTEGER,

  is_enabled BOOLEAN DEFAULT true,
  expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP
);
```

#### keys 表

```sql
CREATE TABLE keys (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  key VARCHAR(255) NOT NULL UNIQUE,
  name VARCHAR(255),
  is_enabled BOOLEAN DEFAULT true,
  expires_at TIMESTAMP,
  can_login_web_ui BOOLEAN DEFAULT false,

  -- 配额字段
  quota_5h_usd DECIMAL(10,4),
  quota_daily_usd DECIMAL(10,4),
  quota_weekly_usd DECIMAL(10,4),
  quota_monthly_usd DECIMAL(10,4),
  quota_total_usd DECIMAL(10,4),
  concurrent_limit INTEGER,

  daily_reset_mode VARCHAR(20) DEFAULT 'fixed',
  provider_group VARCHAR(255),
  cache_ttl_preference VARCHAR(20),

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### providers 表

```sql
CREATE TABLE providers (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL UNIQUE,
  description TEXT,
  url VARCHAR(500) NOT NULL,
  key VARCHAR(500) NOT NULL,
  is_enabled BOOLEAN DEFAULT true,

  -- 调度配置
  weight INTEGER DEFAULT 1,
  priority INTEGER DEFAULT 0,
  cost_multiplier DECIMAL(5,2) DEFAULT 1.0,
  group_tag VARCHAR(255),

  -- 类型配置
  provider_type VARCHAR(50) DEFAULT 'claude',
  model_redirects JSONB DEFAULT '{}',
  allowed_models JSONB DEFAULT '[]',

  -- 超时配置
  first_byte_timeout_streaming_ms INTEGER DEFAULT 0,
  request_timeout_non_streaming_ms INTEGER DEFAULT 0,
  streaming_idle_timeout_ms INTEGER DEFAULT 0,

  -- 代理配置
  proxy_url VARCHAR(500),
  proxy_fallback_to_direct BOOLEAN DEFAULT false,
  preserve_client_ip BOOLEAN DEFAULT false,

  -- 熔断器配置
  circuit_failure_threshold INTEGER DEFAULT 5,
  circuit_open_duration_ms INTEGER DEFAULT 1800000,
  circuit_half_open_success_threshold INTEGER DEFAULT 2,

  -- 配额
  max_retry_attempts INTEGER,
  concurrent_limit INTEGER,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### message_request 表

```sql
CREATE TABLE message_request (
  id SERIAL PRIMARY KEY,
  provider_id INTEGER REFERENCES providers(id),
  user_id INTEGER REFERENCES users(id),
  key VARCHAR(255),
  model VARCHAR(255),

  session_id VARCHAR(255),
  request_sequence INTEGER,
  provider_chain JSONB,

  input_tokens INTEGER DEFAULT 0,
  output_tokens INTEGER DEFAULT 0,
  cache_creation_input_tokens INTEGER DEFAULT 0,
  cache_read_input_tokens INTEGER DEFAULT 0,

  cost_usd DECIMAL(10,6) DEFAULT 0,
  duration_ms INTEGER DEFAULT 0,
  status_code INTEGER,

  endpoint VARCHAR(255),
  original_model VARCHAR(255),
  error_message TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 7. 缓存设计

### 7.1 Redis Key 设计

| Key 模式 | 用途 | TTL |
|----------|------|-----|
| `session:{sessionId}` | Session 数据 | 5 分钟 |
| `session:provider:{sessionId}` | Session 绑定的供应商 | 5 分钟 |
| `circuit:{providerId}` | 熔断器状态 | 30 分钟 |
| `ratelimit:rpm:{userId}` | RPM 计数 | 1 分钟 |
| `ratelimit:cost:{userId}:{period}` | 成本计数 | 按周期 |
| `concurrent:{keyId}` | 并发计数 | 实时 |
| `cache:settings` | 系统设置缓存 | 1 分钟 |
| `cache:providers` | 供应商列表缓存 | 1 分钟 |

### 7.2 缓存策略

| 数据类型 | 策略 | 说明 |
|----------|------|------|
| 系统设置 | Cache-Aside | 读时缓存，写时失效 |
| 供应商列表 | Cache-Aside | 读时缓存，写时失效 |
| Session | Write-Through | 写时同步更新缓存 |
| 限流计数 | Write-Through | 原子操作，Lua 脚本 |
| 熔断状态 | Write-Through | 状态变更时更新 |

---

## 8. 安全架构

### 8.1 认证流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ 请求    │────→│ 提取Key │────→│ 验证Key │────→│ 加载用户│
└─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                      │
                                                      ▼
                                               ┌─────────┐
                                               │ 权限检查│
                                               └─────────┘
```

### 8.2 安全措施

| 措施 | 说明 |
|------|------|
| API Key 认证 | 所有 API 请求需要有效 Key |
| 角色权限 | admin/user 角色区分 |
| 配额限制 | 多维度配额防止滥用 |
| 敏感词过滤 | 内容安全检测 |
| 请求审计 | 完整请求日志 |
| HTTPS Cookie | 安全 Cookie 传输 |
| 输入验证 | Zod Schema 验证 |

---

## 9. 扩展性设计

### 9.1 供应商扩展

添加新供应商类型：

1. 在 `src/app/v1/_lib/proxy/format-mapper.ts` 添加类型映射
2. 在 `src/app/v1/_lib/converters/` 添加格式转换器
3. 在 `src/app/v1/_lib/proxy/forwarder.ts` 添加特殊处理逻辑

### 9.2 守卫扩展

添加新守卫：

1. 在 `src/app/v1/_lib/guards/` 创建新守卫类
2. 实现 `check(session: ProxySession)` 方法
3. 在 `proxy-handler.ts` 中注册守卫

### 9.3 存储扩展

添加新数据表：

1. 在 `src/drizzle/schema.ts` 定义 Schema
2. 运行 `bun run db:generate` 生成迁移
3. 运行 `bun run db:push` 应用迁移
4. 在 `src/repository/` 创建仓库类

---

## 附录

### A. 配置参考

详见 `.env.example` 文件。

### B. API 参考

详见 `/api/actions/scalar` 或 `/api/actions/docs`。

### C. 部署参考

详见 `docker-compose.yaml` 和 `deploy/Dockerfile`。

---

*本文档由 Claude Code 自动生成*
