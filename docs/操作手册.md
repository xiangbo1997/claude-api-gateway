# Claude Code Hub 操作手册

> 版本：1.0.0
> 更新日期：2025-12-14
> 作者：Claude Code

---

## 目录

1. [系统概述](#1-系统概述)
2. [快速开始](#2-快速开始)
3. [用户管理](#3-用户管理)
4. [API Key 管理](#4-api-key-管理)
5. [供应商管理](#5-供应商管理)
6. [配额管理](#6-配额管理)
7. [日志与监控](#7-日志与监控)
8. [系统设置](#8-系统设置)
9. [高级功能](#9-高级功能)
10. [故障排查](#10-故障排查)

---

## 1. 系统概述

### 1.1 什么是 Claude Code Hub

Claude Code Hub（CCH）是一个智能 AI API 代理中转服务平台，专为团队设计，提供：

- **多供应商统一接入**：同时管理 Claude、Codex、Gemini CLI、OpenAI Compatible 等多种 AI 服务
- **智能负载均衡**：基于权重、优先级、分组的智能调度
- **弹性容错**：熔断保护、自动故障转移、最多 3 次重试
- **精细化运营**：多维度限流、配额管理、成本追踪

### 1.2 核心概念

| 概念 | 说明 |
|------|------|
| **用户 (User)** | 系统中的账户实体，可以拥有多个 API Key |
| **API Key** | 用于认证的密钥，关联到特定用户 |
| **供应商 (Provider)** | 上游 AI 服务提供商配置 |
| **Session** | 5 分钟上下文缓存，用于供应商粘性 |
| **熔断器** | 供应商健康状态监控，自动隔离故障节点 |

### 1.3 支持的供应商类型

| 类型 | 说明 | 认证方式 |
|------|------|----------|
| `claude` | 官方 Claude API | `Authorization: Bearer` + `x-api-key` |
| `claude-auth` | Claude 中转服务 | 仅 `Authorization: Bearer` |
| `codex` | OpenAI Codex CLI | `Authorization: Bearer` |
| `gemini-cli` | Google Gemini CLI | API Key 或 OAuth |
| `openai-compatible` | OpenAI 兼容 API | `Authorization: Bearer` |

---

## 2. 快速开始

### 2.1 环境要求

- Docker 与 Docker Compose（推荐最新版本）
- 可选（本地开发）：Node.js ≥ 20，Bun ≥ 1.3

### 2.2 一键部署

```bash
# Linux / macOS
curl -fsSL https://raw.githubusercontent.com/ding113/claude-code-hub/main/scripts/deploy.sh -o deploy.sh
chmod +x deploy.sh
./deploy.sh
```

### 2.3 手动部署

```bash
# 1. 克隆项目
git clone https://github.com/ding113/claude-code-hub.git
cd claude-code-hub

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env，必须修改 ADMIN_TOKEN

# 3. 启动服务
docker compose up -d
```

### 2.4 访问系统

| 地址 | 说明 |
|------|------|
| `http://localhost:23000` | 管理后台 |
| `http://localhost:23000/api/actions/scalar` | API 文档 (Scalar UI) |
| `http://localhost:23000/api/actions/docs` | API 文档 (Swagger UI) |

### 2.5 客户端配置

在 Claude Code 的 `settings.json` 中配置：

```json
{
  "env": {
    "ANTHROPIC_BASE_URL": "http://localhost:23000",
    "ANTHROPIC_AUTH_TOKEN": "你的API Key"
  }
}
```

---

## 3. 用户管理

### 3.1 用户列表

**路径**：`/dashboard/users`

用户列表页面显示所有用户及其基本信息：

| 字段 | 说明 |
|------|------|
| 名称 | 用户显示名称 |
| 角色 | `admin`（管理员）或 `user`（普通用户） |
| 状态 | 启用/禁用 |
| API Keys | 该用户拥有的 Key 数量 |
| 配额 | 各维度配额使用情况 |

### 3.2 创建用户

点击「新建用户」按钮，填写以下信息：

| 字段 | 必填 | 说明 |
|------|------|------|
| 名称 | ✓ | 用户唯一标识名 |
| 描述 | | 用户备注信息 |
| 角色 | ✓ | `admin` 或 `user` |
| RPM 限制 | | 每分钟请求数限制（0=不限制） |
| 日限额 (USD) | | 每日消费限额 |
| 供应商分组 | | 限制用户只能使用特定分组的供应商 |
| 标签 | | 自定义标签，用于分类管理 |

### 3.3 用户配额设置

每个用户可以设置以下配额：

| 配额类型 | 说明 | 重置周期 |
|----------|------|----------|
| 5 小时限额 | 5 小时内最大消费 (USD) | 滚动 5 小时 |
| 每日限额 | 每日最大消费 (USD) | 每日 0 点 |
| 每周限额 | 每周最大消费 (USD) | 每周一 0 点 |
| 每月限额 | 每月最大消费 (USD) | 每月 1 日 0 点 |
| 总限额 | 累计最大消费 (USD) | 不重置 |
| 并发限制 | 同时进行的请求数 | 实时 |

### 3.4 用户权限

| 角色 | 权限 |
|------|------|
| `admin` | 完全管理权限，可查看所有数据 |
| `user` | 仅能查看自己的使用数据 |

---

## 4. API Key 管理

### 4.1 Key 列表

**路径**：`/dashboard/users` → 点击用户 → 查看 Keys

每个 Key 显示以下信息：

| 字段 | 说明 |
|------|------|
| Key | 以 `sk-` 开头的密钥（部分隐藏） |
| 名称 | Key 的显示名称 |
| 状态 | 启用/禁用 |
| 过期时间 | Key 的有效期 |
| Web 登录 | 是否允许使用此 Key 登录管理后台 |

### 4.2 创建 API Key

| 字段 | 必填 | 说明 |
|------|------|------|
| 名称 | ✓ | Key 的显示名称 |
| 过期时间 | | 留空表示永不过期 |
| 允许 Web 登录 | | 是否可用于登录管理后台 |
| 供应商分组 | | 限制此 Key 只能使用特定分组 |
| 缓存 TTL 偏好 | | `inherit`/`5m`/`1h` |

### 4.3 Key 配额设置

Key 级别的配额会覆盖用户级别的配额：

| 配额类型 | 说明 |
|----------|------|
| 5 小时限额 | 此 Key 的 5 小时消费限额 |
| 每日限额 | 此 Key 的每日消费限额 |
| 每周限额 | 此 Key 的每周消费限额 |
| 每月限额 | 此 Key 的每月消费限额 |
| 总限额 | 此 Key 的累计消费限额 |
| 并发限制 | 此 Key 的并发请求数限制 |

### 4.4 每日重置模式

| 模式 | 说明 |
|------|------|
| `fixed` | 固定时间重置（每日 0 点） |
| `rolling` | 滚动 24 小时窗口 |

---

## 5. 供应商管理

### 5.1 供应商列表

**路径**：`/dashboard/quotas` → 供应商配额

供应商列表显示所有配置的上游服务：

| 字段 | 说明 |
|------|------|
| 名称 | 供应商显示名称 |
| 类型 | `claude`/`claude-auth`/`codex` 等 |
| URL | 上游服务地址 |
| 状态 | 启用/禁用 |
| 权重 | 负载均衡权重 |
| 优先级 | 调度优先级（数字越小优先级越高） |
| 熔断状态 | `closed`/`open`/`half-open` |

### 5.2 创建供应商

#### 基本配置

| 字段 | 必填 | 说明 |
|------|------|------|
| 名称 | ✓ | 供应商唯一标识名 |
| 描述 | | 供应商备注信息 |
| URL | ✓ | 上游服务地址（如 `https://api.anthropic.com`） |
| API Key | ✓ | 上游服务的认证密钥 |
| 类型 | ✓ | 供应商类型 |

#### 调度配置

| 字段 | 默认值 | 说明 |
|------|--------|------|
| 权重 | 1 | 负载均衡权重，权重越高被选中概率越大 |
| 优先级 | 0 | 调度优先级，数字越小优先级越高 |
| 成本系数 | 1.0 | 计费时的成本倍率 |
| 分组标签 | | 用于分组调度 |

#### 模型配置

| 字段 | 说明 |
|------|------|
| 允许的模型 | 限制此供应商支持的模型列表 |
| 模型重定向 | 将请求的模型名映射到实际模型名 |

**模型重定向示例**：
```json
{
  "claude-3-5-sonnet-latest": "claude-3-5-sonnet-20241022",
  "claude-3-opus-latest": "claude-3-opus-20240229"
}
```

#### 超时配置

| 字段 | 默认值 | 说明 |
|------|--------|------|
| 流式首字节超时 | 0 (禁用) | 流式请求等待首字节的超时时间 (ms) |
| 非流式总超时 | 0 (禁用) | 非流式请求的总超时时间 (ms) |
| 流式静默超时 | 0 (禁用) | 流式响应中连续静默的超时时间 (ms) |

#### 代理配置

| 字段 | 说明 |
|------|------|
| 代理 URL | HTTP/HTTPS/SOCKS5 代理地址 |
| 降级到直连 | 代理失败时是否自动切换到直连 |
| 保留客户端 IP | 是否透传客户端 IP 到上游 |

#### 熔断器配置

| 字段 | 默认值 | 说明 |
|------|--------|------|
| 失败阈值 | 5 | 触发熔断的连续失败次数 |
| 熔断时长 | 30 分钟 | 熔断器打开后的等待时间 |
| 半开成功阈值 | 2 | 半开状态下恢复所需的成功次数 |

### 5.3 供应商类型详解

#### claude（官方 Claude API）

适用于直接连接 Anthropic 官方 API：

- URL: `https://api.anthropic.com`
- 认证：同时发送 `Authorization: Bearer` 和 `x-api-key`

#### claude-auth（Claude 中转服务）

适用于第三方 Claude 中转服务：

- 认证：仅发送 `Authorization: Bearer`
- 不发送 `x-api-key`（避免与中转服务冲突）

#### codex（OpenAI Codex CLI）

适用于 OpenAI Codex CLI 服务：

- 自动处理 `instructions` 字段
- 支持 `auto`/`official`/`custom` 指令策略

#### gemini-cli（Google Gemini CLI）

适用于 Google Gemini CLI 服务：

- 支持 API Key 和 OAuth 认证
- 自动处理 gzip 压缩响应

#### openai-compatible（OpenAI 兼容 API）

适用于 OpenAI 兼容的第三方服务：

- 自动格式转换
- 支持 `/v1/chat/completions` 端点

### 5.4 熔断器状态

| 状态 | 说明 |
|------|------|
| `closed` | 正常状态，请求正常转发 |
| `open` | 熔断状态，请求直接失败 |
| `half-open` | 半开状态，允许少量请求测试恢复 |

---

## 6. 配额管理

### 6.1 配额层级

配额按以下层级生效（优先级从高到低）：

1. **Key 级别**：最高优先级
2. **用户级别**：Key 未设置时使用
3. **系统级别**：全局默认值

### 6.2 配额类型

| 类型 | 说明 | 计算方式 |
|------|------|----------|
| RPM | 每分钟请求数 | 滑动窗口 |
| 5 小时限额 | 5 小时内消费 (USD) | 滑动窗口 |
| 每日限额 | 每日消费 (USD) | 固定/滚动 |
| 每周限额 | 每周消费 (USD) | 固定周期 |
| 每月限额 | 每月消费 (USD) | 固定周期 |
| 总限额 | 累计消费 (USD) | 累计 |
| 并发限制 | 同时请求数 | 实时计数 |

### 6.3 配额查看

**路径**：`/dashboard/quotas`

配额页面分为三个标签页：

1. **用户配额**：查看所有用户的配额使用情况
2. **Key 配额**：查看所有 Key 的配额使用情况
3. **供应商配额**：查看所有供应商的配额使用情况

### 6.4 配额重置

- **5 小时限额**：滚动窗口，自动重置
- **每日限额**：
  - `fixed` 模式：每日 0 点重置
  - `rolling` 模式：滚动 24 小时窗口
- **每周限额**：每周一 0 点重置
- **每月限额**：每月 1 日 0 点重置
- **总限额**：不自动重置，需手动清零

---

## 7. 日志与监控

### 7.1 请求日志

**路径**：`/dashboard/logs`

日志页面显示所有 API 请求记录：

| 字段 | 说明 |
|------|------|
| 时间 | 请求时间 |
| 用户 | 发起请求的用户 |
| 供应商 | 处理请求的供应商 |
| 模型 | 请求的模型 |
| Token | 输入/输出 Token 数 |
| 成本 | 请求成本 (USD) |
| 耗时 | 请求处理时间 |
| 状态 | HTTP 状态码 |

#### 筛选条件

- 时间范围
- 用户
- 供应商
- 模型
- 状态码

### 7.2 决策链

每个请求都记录完整的决策链，包括：

- 供应商选择过程
- 重试记录
- 熔断器状态
- 错误信息

点击日志条目可查看详细决策链。

### 7.3 实时监控

**路径**：`/dashboard/sessions`

Session 监控页面显示：

- 当前活跃 Session 数
- 各供应商的 Session 分布
- 并发请求数

### 7.4 排行榜

**路径**：`/dashboard/leaderboard`

排行榜显示使用统计：

| 维度 | 说明 |
|------|------|
| 用户排行 | 按消费/请求数排序的用户列表 |
| 供应商排行 | 按使用量排序的供应商列表 |
| 模型排行 | 按使用量排序的模型列表 |

支持按日/周/月筛选。

### 7.5 可用性监控

**路径**：`/dashboard/availability`

可用性页面显示：

- 各供应商的健康状态
- 熔断器状态
- 成功率统计
- 响应时间分布

---

## 8. 系统设置

### 8.1 基本设置

**路径**：`/dashboard/settings`

| 设置项 | 说明 |
|--------|------|
| 站点标题 | 管理后台显示的标题 |
| 货币显示 | USD/CNY/EUR |
| 计费模型来源 | 使用原始模型还是重定向后的模型计费 |

### 8.2 安全设置

| 设置项 | 说明 |
|--------|------|
| 客户端版本检查 | 是否检查客户端版本 |
| 最低版本要求 | 允许的最低客户端版本 |
| 详细错误信息 | 是否返回详细的供应商错误信息 |

### 8.3 性能设置

| 设置项 | 说明 |
|--------|------|
| HTTP/2 支持 | 是否启用 HTTP/2 连接 |
| 自动清理 | 日志保留天数和清理计划 |

### 8.4 通知设置

**路径**：`/dashboard/settings/notifications`

支持配置企业微信机器人通知：

| 事件类型 | 说明 |
|----------|------|
| 熔断器打开 | 供应商熔断时通知 |
| 配额告警 | 配额使用超过阈值时通知 |
| 系统错误 | 系统异常时通知 |

---

## 9. 高级功能

### 9.1 请求过滤器

**路径**：`/dashboard/settings/filters`

请求过滤器可以修改请求和响应：

| 字段 | 说明 |
|------|------|
| 名称 | 过滤器名称 |
| 类型 | `request`（请求）或 `response`（响应） |
| 匹配条件 | JSONPath 表达式 |
| 操作 | `set`/`delete`/`replace` |

### 9.2 敏感词过滤

**路径**：`/dashboard/settings/sensitive-words`

配置敏感词检测：

| 匹配类型 | 说明 |
|----------|------|
| `contains` | 包含匹配 |
| `exact` | 精确匹配 |
| `regex` | 正则表达式匹配 |

### 9.3 错误规则

**路径**：`/dashboard/settings/error-rules`

自定义错误处理规则：

| 字段 | 说明 |
|------|------|
| 匹配模式 | 错误消息匹配规则 |
| 分类 | 错误分类（供应商错误/客户端错误等） |
| 是否重试 | 是否允许重试 |
| 是否计入熔断 | 是否计入熔断器失败计数 |

### 9.4 价格表管理

**路径**：`/dashboard/settings/prices`

管理模型价格：

- 支持从 LiteLLM 同步价格
- 支持手动添加/编辑价格
- 支持搜索和分页

### 9.5 MCP 透传

供应商支持 MCP（Model Context Protocol）透传：

| 类型 | 说明 |
|------|------|
| `none` | 不启用 MCP 透传 |
| `minimax` | Minimax MCP 透传 |
| `glm` | GLM MCP 透传 |

---

## 10. 故障排查

### 10.1 常见错误

#### 所有供应商暂时不可用

**原因**：
- 所有供应商都处于熔断状态
- 没有启用的供应商
- 配额已用尽

**解决方案**：
1. 检查供应商状态
2. 清除 Redis 熔断器状态：`redis-cli FLUSHALL`
3. 检查配额使用情况

#### 认证失败

**原因**：
- API Key 无效或已过期
- Key 已被禁用

**解决方案**：
1. 检查 Key 是否正确
2. 检查 Key 是否启用
3. 检查 Key 是否过期

#### 上游返回 403

**原因**：
- 上游服务 API Key 无效
- 上游服务有 IP 限制
- 请求头格式不正确

**解决方案**：
1. 检查供应商 API Key
2. 检查供应商类型是否正确
3. 查看详细日志

### 10.2 日志查看

```bash
# Docker 日志
docker compose logs -f app

# 本地开发日志
bun run dev
```

### 10.3 Redis 状态检查

```bash
# 连接 Redis
redis-cli -p 36379

# 查看所有 Key
KEYS *

# 查看熔断器状态
KEYS circuit:*

# 清除所有状态
FLUSHALL
```

### 10.4 数据库检查

```bash
# 连接数据库
docker exec -it claude-code-hub-db psql -U postgres -d claude_code_hub

# 查看供应商
SELECT id, name, provider_type, is_enabled FROM providers;

# 查看用户
SELECT id, name, role, is_enabled FROM users;
```

---

## 附录

### A. 环境变量参考

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `ADMIN_TOKEN` | `change-me` | 管理员登录令牌 |
| `DSN` | - | PostgreSQL 连接串 |
| `REDIS_URL` | `redis://localhost:6379` | Redis 连接地址 |
| `APP_PORT` | `23000` | 应用端口 |
| `AUTO_MIGRATE` | `true` | 自动数据库迁移 |
| `ENABLE_RATE_LIMIT` | `true` | 启用限流 |
| `SESSION_TTL` | `300` | Session 缓存时间（秒） |
| `ENABLE_SECURE_COOKIES` | `true` | 强制 HTTPS Cookie |
| `MAX_RETRY_ATTEMPTS_DEFAULT` | `2` | 默认重试次数 |

### B. API 端点参考

| 端点 | 方法 | 说明 |
|------|------|------|
| `/v1/messages` | POST | Claude API 兼容 |
| `/v1/chat/completions` | POST | OpenAI API 兼容 |
| `/v1/responses` | POST | Codex CLI 兼容 |
| `/v1/models` | GET | 模型列表 |
| `/api/auth/login` | POST | 登录认证 |

### C. 支持的模型

系统支持所有 Claude、OpenAI、Gemini 模型，具体取决于供应商配置。

---

*本文档由 Claude Code 自动生成*
