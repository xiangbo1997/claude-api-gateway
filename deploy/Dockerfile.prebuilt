# Dockerfile - 使用预构建的 .next 目录（跳过 bun run build）
# 适用于本地已构建好，服务器内存不足的情况

FROM docker.1ms.run/library/node:22-slim AS runner
ENV NODE_ENV=production
ENV PORT=3000
ENV HOST=0.0.0.0
WORKDIR /app

# 只安装 curl 用于健康检查
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# 直接复制预构建的文件
COPY --chown=node:node public ./public
COPY --chown=node:node drizzle ./drizzle
COPY --chown=node:node messages ./messages
COPY --chown=node:node .next/standalone ./
COPY --chown=node:node .next/server ./.next/server
COPY --chown=node:node .next/static ./.next/static

USER node
EXPOSE 3000

CMD ["node", "server.js"]
